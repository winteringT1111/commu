{% extends "base.html" %}
{% load static %}

{% block head %}
<link rel="stylesheet" type="text/css" href="{% static 'css/class/flying.css' %}">
{% endblock %}

{% block content %}
<div class="overlay"></div>
<div class="gradient-overlay"></div>

<div class="goback">
    <a href="/class"><i class="fa-solid fa-chevron-left"></i></a>
</div>

<div class="flying_background">
    <div class="flying_title">
        Flying
    </div>

    <div class="selected_box">
        <p>획득 가능한 아이템</p>
        <div class="selected">기숙사 점수</div>
    </div>

    <div class="selected_image">
        <img src="{% static 'img/빗자루_실루엣.png' %}" alt="빗자루">
        <div class="item_description">
            <p>빗자루</p>
            <p class="category">소지품</p>
            <p class="item_info">사용자의 이름이 각인된 빗자루다.</p>
        </div>
    </div>

    <div class="modal_info">
        <p><span><img src="{% static 'img/star.png' %}"></span>수업 이수 시 1 수업 토큰이 소모됩니다.</p>
        <p>누적 출석 7회 시 빗자루 아이템을 획득할 수 있습니다.</p>
    </div>

    <div class="modal_info2">
        <p>누적 출석 수: <span id="attendance-count">{{total_attendance}}일</span></p>
        <p>빗자루 수령 여부: <span id="broom-status">X</span></p>
    </div>

    <button type="button" class="herb_btn" id="complete-class-btn">
        수업 이수
    </button>

</div>

<!-- 모달 -->
<div class="modal fade" id="completionModal" tabindex="-1" role="dialog" aria-labelledby="completionModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="completionModalLabel">수업 이수 완료</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>수업을 이수했습니다.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const completeClassButton = document.getElementById('complete-class-btn');
        const attendanceCount = document.getElementById('attendance-count');
        const broomStatus = document.getElementById('broom-status');
        const modal = new bootstrap.Modal(document.getElementById('completionModal'));
    
        completeClassButton.addEventListener('click', function() {
            fetch('{% url "main:shifter" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',  // CSRF 토큰 포함
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})  // 비어있는 JSON 객체 보내기
            })
            .then(response => response.json())
            .then(data => {
                if (data.total_attendance) {
                    // 출석 수 업데이트
                    attendanceCount.textContent = `${data.total_attendance}일`;
                    
                    // 빗자루 수령 여부 업데이트
                    broomStatus.textContent = data.broom_received ? 'O' : 'X';
                    
                    // 모달 띄우기
                    modal.show();  // 모달 띄우기
                } else {
                    console.error('Error:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    });
    
</script>

<!-- jQuery 로드 (Bootstrap 4에서 필요) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap JS 로드 -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

{% endblock %}
