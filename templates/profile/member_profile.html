{% extends "base.html" %}
{% load static %}

{% block head %}
<link rel="stylesheet" type="text/css" href="{% static 'css/member/profile.css' %}">
{% endblock %}

{% block content %}

<div class="overlay"></div> <!-- 흐림 효과 적용 영역 -->

<a href="/member"><div class="goback">
    <i class="fa-solid fa-chevron-left"></i>
</div></a>

<div class="content">

<!-- 캐릭터 -->
<div class="character_wrap">
    <div class="cha">
        {% if char.charFirstName == "Yvonne" or char.charFirstName == "Finley" or char.charFirstName == "Ezekiel" or char.charFirstName == "Nathan" or char.charFirstName == "Ezell"  or char.charFirstName == "Rebecca"  or char.charFirstName == "Remia"%}
        <img class="character2" id=""src="{% static 'img/charac/01/02/' %}{{ char.charImageA }}.png"></img>
        {% elif char.charFirstName == "Sophia" %}
        <img class="character3" src="{% static 'img/charac/01/02/' %}{{ char.charImageA }}.png"></img>
        {% else %}
        <img class="character" src="{% static 'img/charac/01/02/' %}{{ char.charImageA }}.png"></img>
        {% endif %}
    </div>
</div>

{% if char.charProfileMusic %}
<div id="profile_music" class="hidden" data-music="{{char.charProfileMusic}}.mp3"></div>
{% else %}
{% endif %}

<div class="wrap fade-in-right">
    <div class="inven">
        <button class="transbtn" onclick="show1grade()">Grade 1</button>
        <button class="transbtn" onclick="showInventory()">인벤토리</button>
    </div>

 <!-- 기본정보 -->
 <div class="info_wrap" id="profile-section">
    <div class="info_content">
        <div class="catchphrase">
            [ {{char.charCatchPhrase}} ]
        </div>
        <div class="name_wrap">
            <div class="name_content">
                <p class="name1">
                    {{char.charEngName}}
                </p>
                <p class="name2">
                    {{char.charName}}
                </p>
            </div>
        </div>
        <div class="phrase">
            <p><span>"  </span> {{char.charPhrase}} <span>  "</span></p>
        </div>
        <div class="spec_wrap">
            <div class="spec_content">
                <div class="spec_info_content">
                    <div class="info_line_content">
                        <p>{{char.charSex}} | {{char.charHeight}}cm | {{char.charWeight}}kg | {{char.charNationality}} | {{char.charBlood}}</p>
                    </div>
                </div>
                {% if char.charHouse == "후플푸프" %}
                    <img class="houseimgH" src="{% static 'img/' %}{{ char.charHouse }}.png">
                {% else %}
                    <img class="houseimg" src="{% static 'img/' %}{{ char.charHouse }}.png">
                {% endif %}
            </div>
        </div>
    </div>

    <div class="button_content">
        <div class="button_wrap">
            <button class="infobtn" onclick="showProfile()">기본 정보</button>
            {% if char.charCommission  or char.charImageInfo %}
            <button class="infobtn" onclick="showImgInfo()">외관</button>
            {% endif %}
            <button class="infobtn" onclick="showEtc()">상세 정보</button>
            <button class="infobtn" onclick="showWand()">지팡이</button>
        </div>
    </div>

    <div class="personality_content" id="personality_section">
        <div class="personality_wrap">
            <div class="keywords">
                <button class="keywordbtn">{{char.charKeyword1}}</button>
                <button class="keywordbtn">{{char.charKeyword2}}</button>
                <button class="keywordbtn">{{char.charKeyword3}}</button>
            </div>
            <hr/>
            <div class="info_scrollbox">
                {{char.charPersonality|linebreaksbr|safe}}
            </div>
            <hr/>
        </div>
    </div>

    <div class="imgInfo_content hidden" id="imgInfo_section">
        <div class="personality_wrap">
            {% if char.charCommission %}
            <div class="imgInfo_header">
                <button class="keywordbtn">ⓒ {{char.charCommissionInfo}}</button>
            </div>
            <hr/>
            <div class="info_scrollbox">
                {{char.charImageInfo|linebreaksbr|safe}}
            </div>
            <hr/>
            {% else %}
            <hr class="mod"/>
            <div class="info_scrollbox2">
                {{char.charImageInfo|linebreaksbr|safe}}
            </div>
            <hr/>
            {% endif %}
        </div>
    </div>

    <div class="etc_content hidden" id="etc_section">
        <div class="personality_wrap">
            <div class="imgInfo_header">
            </div>
            <hr/>
            <div class="info_scrollbox2">
                {{char.charEtc|linebreaksbr|safe}}
            </div>
            <hr/>
        </div>
    </div>

    <div class="wand_content hidden" id="wand_section">
        <div class="personality_wrap">
            <div class="keywords">
                <button class="keywordbtn">{{char.charWand1}}</button>
                <button class="keywordbtn">{{char.charWand2}}</button>
                <button class="keywordbtn">{{char.charWand3}}"</button>
                <button class="keywordbtn">{{char.charWand4}}</button>
            </div>
            <hr/>
            <div class="info_scrollbox">
                {% if char.charWandInfo %}
                {{char.charWandInfo|linebreaksbr|safe}}
                {% elif char.charFirstName == "Patch" %}
                <img src={% static "img/패치포트리스.png" %}>
                {% else %}
                {% endif %}
            </div>
            <hr/>
        </div>
    </div>

</div>


 <!-- 인벤토리 -->
 <div class="inventory_wrap hidden" id="inventory-section">
    <div class="inven_banner">
        <img src={% static "img/인벤토리 배너.png" %}>
    </div>

    <div class="inventory_content">
        <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel" data-interval="false">
            <ol class="carousel-indicators">
                {% for i in pages_items %}
                    <li data-target="#carouselExampleIndicators" data-slide-to="{{ forloop.counter0 }}" class="{% if forloop.first %}active{% endif %}"></li>
                {% endfor %}
            </ol>
            <div class="carousel-inner">
                {% for items in pages_items %}
                    <div class="carousel-item {% if forloop.first %}active{% endif %}">
                        <div class="item_wrap">
                            <div class="item_wrap2">
                            {% for item in inven %}
                                <div class="item">
                                    <p class="item_count">x{{item.itemCount}}</p>
                                    <img src="{% static 'img/store/' %}{{ item.itemInfo.itemName }}.png">
                                    <div class="item_description">
                                        <p>{{ item.itemInfo.itemName }}</p>
                                        <p class="category">{{ item.itemInfo.itemCategory }}</p>
                                        <p class="item_info">{{ item.itemInfo.itemInfo }}</p>
                                        {% if characinfo.user == user %}
                                        <div class="ibtn_wrap">
                                            {% if item.itemInfo.itemName == '포춘쿠키' %}
                                            <!--포춘쿠키-->
                                            <button class="itembtn" onclick="showUseModal('포춘쿠키')">사용</button>
                                            {% elif item.itemInfo.itemName == '타임터너' %}
                                            <!--타임터너-->
                                            <button class="itembtn" onclick="showUseModal2('타임터너')">사용</button>
                                            {% elif item.itemInfo.itemName == '마법 주머니' %}
                                            <!--마법주머니-->
                                            <button class="itembtn" onclick="showUseModal3('마법주머니')">사용</button>
                                            {% elif item.itemInfo.itemName == '고급 마법 주머니' %}
                                            <!--고급마법주머니-->
                                            <button class="itembtn" onclick="showUseModal4('고급마법주머니')">사용</button>
                                            {% elif item.itemInfo.itemCategory == '마법 재료' %}
                                            <!-- 양도 버튼 추가 -->
                                            <button class="itembtn" onclick="openTransferModal('{{ item.itemInfo.itemName }}')">양도</button>
                                            {% else %}
                                            {% endif %}
                                        </div>
                                        {% else %}
                                        {% endif %}
                                    </div>                                
                            </div>
                            {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <button class="carousel-control-prev" type="button" data-target="#carouselExampleIndicators" data-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-target="#carouselExampleIndicators" data-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
            </button>
        </div>
    </div>

    <div class="inventory_token">
        <img src={% static "img/갈레온.png" %}>
        <div class="inventoken">
            {{characinfo.galeon}}
        </div>
        <img src={% static "img/토큰.png" %}>
        <div class="inventoken">
            {{characinfo.classToken}}
        </div>
    </div>
</div>

</div>



<div class="modal fade" id="fortuneCookieModal"  data-backdrop="static" tabindex="-1" aria-labelledby="fortuneCookieModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-100 w-75">
        <div class="modal-content" id="pm">
            <div class="modal-body">
                <div class="plscenter">
                <h2>포춘쿠키</h2>
                <p id="fortuneMessage">{{ random_fortune }}</p>  <!-- 랜덤 메시지 -->
                <button type="button" onclick="useItem()" id="yesbtn">확인</button>  <!-- 사용 버튼 -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="TimeTurnerModal"  data-backdrop="static" tabindex="-1" aria-labelledby="fortuneCookieModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-100 w-75">
        <div class="modal-content" id="pm">
            <div class="modal-body">
                <div class="plscenter">
                <h2>타임터너</h2>
                <p id="fortuneMessage">수업 토큰 1개를 획득했습니다.</p>  <!-- 랜덤 메시지 -->
                <button type="button" onclick="useItem2()" id="yesbtn">확인</button>  <!-- 사용 버튼 -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="MagicItemModal"  data-backdrop="static" tabindex="-1" aria-labelledby="fortuneCookieModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-100 w-75">
        <div class="modal-content" id="pm">
            <div class="modal-body">
                <form method="POST" action="">
                {% csrf_token %}
                    <input type="hidden" name="boxtype" value="magic">
                    <div class="selected_image_box">
                        <div class="selected_image">
                            {% for mitem in magicItem %}
                            <input type="hidden" name="magic_item_names" value="{{ mitem.itemName }}">
                            <span><img src="{% static 'img/store/' %}{{ mitem.itemName }}.png"></span>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="plscenter2">
                    <p id="fortuneMessage">마법 재료를 획득했습니다.</p>  
                    <button type="submit" id="yesbtn2">확인</button> 
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="GoldMagicItemModal"  data-backdrop="static" tabindex="-1" aria-labelledby="fortuneCookieModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-100 w-75">
        <div class="modal-content" id="pm">
            <div class="modal-body">
                <form method="POST" action="">
                {% csrf_token %}
                <input type="hidden" name="boxtype" value="goldmagic">
                    <div class="selected_image_box">
                        <div class="selected_image2">
                            {% for mitem in magicItem2 %}
                            <input type="hidden" name="magic_item_names" value="{{ mitem.itemName }}">
                            <span><img src="{% static 'img/store/' %}{{ mitem.itemName }}.png"></span>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="plscenter2">
                    <p id="fortuneMessage">마법 재료를 획득했습니다.</p>  
                    <button type="submit" id="yesbtn2">확인</button> 
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-100 w-75">
        <div class="modal-content" id="pm">
            <div class="modal-body">
                <div class="character_select">
                    <label for="characterSelect">양도할 대상</label>
                    <select id="characterSelect" class="form-control">
                        {% for character in charnames %}
                            <option value="{{character}}">{{character}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="hidden" id="itemName"></div>
                <button type="button" class="yesbtn2" onclick="transferItem()" id="confirmBtn">확인</button>
            </div>
        </div>
    </div>
</div>



<script>

        // 모달 열기 및 닫기 (Bootstrap 방식)
        function openModal() {
            $('#fortuneCookieModal').modal('show');
        }
    
        function closeModal() {
            $('#fortuneCookieModal').modal('hide');
        }
    
        // "사용" 버튼 클릭 시 모달 열기
        function showUseModal(itemName) {
            if (itemName === "포춘쿠키") {
                openModal();  // 모달 열기
            }
        }
    
        // "확인" 버튼 클릭 시 서버로 요청 보내기
        function useItem() {
            // 포춘쿠키 사용 처리하는 AJAX 요청 보내기
            fetch('/use_fortune_cookie/', {  // 포춘쿠키 사용을 위한 서버 엔드포인트
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',  // CSRF 토큰을 포함
                },
                body: JSON.stringify({ 'item_name': 'fortune_cookie' })  // 아이템 이름을 서버로 전송
            })
            // 모달 닫기
            closeModal();
            location.reload();
        }

        function openModal2() {
            $('#TimeTurnerModal').modal('show');
        }
    
        function closeModal2() {
            $('#TimeTurnerModal').modal('hide');
        }
    
        // "사용" 버튼 클릭 시 모달 열기
        function showUseModal2(itemName) {
            if (itemName === "타임터너") {
                openModal2();  // 모달 열기
            }
        }
    
        // "확인" 버튼 클릭 시 서버로 요청 보내기
        function useItem2() {
            // 포춘쿠키 사용 처리하는 AJAX 요청 보내기
            fetch('/use_fortune_cookie/', {  // 포춘쿠키 사용을 위한 서버 엔드포인트
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',  // CSRF 토큰을 포함
                },
                body: JSON.stringify({ 'item_name': 'time_turner' })  // 아이템 이름을 서버로 전송
            })
            // 모달 닫기
            closeModal2();
            location.reload();
        }

        function openModal3() {
            $('#MagicItemModal').modal('show');
        }
    
        function closeModal3() {
            $('#MagicItemModal').modal('hide');
        }
    
        // "사용" 버튼 클릭 시 모달 열기
        function showUseModal3(itemName) {
            if (itemName === "마법주머니") {
                openModal3();  // 모달 열기
            }
        }
   
        function openModal4() {
            $('#GoldMagicItemModal').modal('show');
        }
    
        function closeModal4() {
            $('#GoldMagicItemModal').modal('hide');
        }
    
        // "사용" 버튼 클릭 시 모달 열기
        function showUseModal4(itemName) {
            if (itemName === "고급마법주머니") {
                openModal4();  // 모달 열기
            }
        }
    


    document.addEventListener('DOMContentLoaded', () => {
        const wrapElement = document.querySelector('.wrap');
        wrapElement.classList.add('fade-in-right');
    });
    function showImgInfo() {
        document.getElementById('imgInfo_section').classList.remove('hidden');
        document.getElementById('personality_section').classList.add('hidden');
        document.getElementById('etc_section').classList.add('hidden');
        document.getElementById('wand_section').classList.add('hidden');
    }

    function showProfile() {
        document.getElementById('imgInfo_section').classList.add('hidden');
        document.getElementById('personality_section').classList.remove('hidden');
        document.getElementById('etc_section').classList.add('hidden');
        document.getElementById('wand_section').classList.add('hidden');
    }

    function showEtc() {
        document.getElementById('imgInfo_section').classList.add('hidden');
        document.getElementById('personality_section').classList.add('hidden');
        document.getElementById('etc_section').classList.remove('hidden');
        document.getElementById('wand_section').classList.add('hidden');
    }

    function showWand() {
        document.getElementById('imgInfo_section').classList.add('hidden');
        document.getElementById('personality_section').classList.add('hidden');
        document.getElementById('etc_section').classList.add('hidden');
        document.getElementById('wand_section').classList.remove('hidden');
    }

    function show1grade() {
        document.getElementById('profile-section').classList.remove('hidden');
        document.getElementById('inventory-section').classList.add('hidden');
    }
    function showInventory() {
        document.getElementById('profile-section').classList.add('hidden');
        document.getElementById('inventory-section').classList.remove('hidden');
    }

    let selectedItem = '';  // 양도할 아이템 이름

// "양도" 버튼 클릭 시 호출되는 함수
function openTransferModal(itemName) {
    selectedItem = itemName;  // 양도할 아이템 이름 저장
    document.getElementById('itemName').innerText = itemName;  // 아이템 이름 표시
    console.log(itemName);

    $('#transferModal').modal('show');  // 모달 열기
}

// 모달 닫기
function closeTransferModal() {
    $('#transferModal').modal('hide');
}

// 양도 확인 버튼 클릭 시 서버로 데이터 전송
function transferItem() {
    const selectedCharacterId = document.getElementById('characterSelect').value;  // 선택된 캐릭터 ID

    // AJAX로 서버에 양도 요청 보내기
    fetch('/transfer_item/', {  // 양도 요청을 처리할 서버 엔드포인트
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',  // CSRF 토큰 포함
        },
        body: JSON.stringify({
            'item_name': selectedItem,
            'character_id': selectedCharacterId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('양도가 완료되었습니다.');
            location.reload();  // 페이지 새로고침
        } else {
            alert('양도 실패: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('서버 오류');
    });

    closeTransferModal();  // 모달 닫기
}

</script>

{% endblock %}